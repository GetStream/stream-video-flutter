import "../../Fastfile"

default_platform(:ios)

before_all do
  if is_ci
    setup_ci()
  end
end

platform :ios do

  lane :archive do |options|
    method = options[:method]

    build_app(
      export_method: method,
      silent: true,
      clean: true,
      include_symbols: true,
      output_directory: "./dist",
    )
  end

  lane :build do |options|
    # Reuse parent fastfile tasks
    fetch_dependencies
    build_autogenerated_code


    sign_enabled = options[:sign_enabled] || false
    sign_param = sign_enabled ? '' : '--no-codesign'

    config_only = options[:config_only] || false
    config_param = config_only ? '--config-only' : ''

    sh_on_root(command: "flutter build ios --no-pub --suppress-analytics --release #{sign_param} #{config_param}")
  end

  lane :build_and_deploy do
    app_store_connect_api_key

    match(readonly: is_ci)

    current_build_number = app_store_build_number(live: false)
    
    increment_build_number(build_number: current_build_number + 1)

    build(sign_enabled: true)
    archive(method: "app-store")

    begin
      upload_to_testflight(
        distribute_external: true,
        notify_external_testers: true,
        groups: ['Internal Testers', 'External Testers'],
        changelog: "Lots of amazing new features to test out!",
        reject_build_waiting_for_review: false,
        skip_waiting_for_build_processing: false,
      )
    rescue Exception => e
      if e.message.include? "Another build is in review"
        UI.important("Another build is already in beta review. Skipping beta review submission")
      else
        UI.user_error!(e)
      end
    end
  end

end