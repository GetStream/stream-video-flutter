import "../../Fastfile"

default_platform(:android)

platform :android do
  lane :build_appbundle do |options|
    # Reuse parent fastfile tasks
    fetch_dependencies
    build_autogenerated_code

    sh_on_root(command: "flutter build appbundle --flavor #{options[:flavor]} --no-pub --release --suppress-analytics")
  end

  lane :build_and_deploy do |options|
    
    previous_build_number = google_play_track_version_codes(
      track: "internal",
      json_key: "firebase-service-account.json",
    )[0]
      
    current_build_number = previous_build_number + 1
      
    increment_version_code(
      version_code: current_build_number
    )
        
    build_appbundle(flavor: options[:flavor])

    is_prod = options[:flavor] == 'prod'

    upload_to_play_store(
      track: is_prod ? 'production' : 'internal',
      aab: "../build/app/outputs/bundle/#{options[:flavor]}Release/app-#{options[:flavor]}-release.aab",
      skip_upload_screenshots: true,
      skip_upload_images: true,
      skip_upload_changelogs: true,
      release_status: "completed"
    )
  end
end