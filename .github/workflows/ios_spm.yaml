name: iOS Build CI (CocoaPods + SPM)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"

      - name: Flutter pub get
        run: flutter pub get

      # ðŸ§ª Build iOS dogfooding using CocoaPods
      - name: Build iOS dogfooding with CocoaPods
        working-directory: dogfooding
        run: |
          echo "=== Building with CocoaPods ==="
          cd ios
          pod repo update
          pod install
          cd ..
          flutter config --no-enable-swift-package-manager
          flutter build ios --no-codesign --verbose

      # ðŸ§¹ Clean build + prepare for SPM test
      - name: Clean and prepare for SPM test
        working-directory: dogfooding
        run: |
          echo "=== Cleaning Pods ==="
          rm -rf ios/Pods ios/Podfile.lock
          flutter clean

      # ðŸ§ª Step 7: Build iOS dogfooding using Swift Package Manager
      - name: Build iOS dogfooding with Swift Package Manager
        working-directory: dogfooding
        run: |
          echo "=== Building with SPM ==="
          flutter config --enable-swift-package-manager
          flutter build ios --no-codesign --verbose

      # âœ… Step 8: Verify output
      - name: Verify build artifacts
        run: |
          echo "âœ… Both CocoaPods and SPM builds succeeded."
